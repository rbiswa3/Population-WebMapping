<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WA COVID-19 Cases per 10k</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map {
            width: 100%;
            height: 80vh; 
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom styles for the interactive elements */
        .map-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
            max-width: 250px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.875rem;
        }
        .color-box {
            width: 20px;
            height: 12px;
            margin-right: 10px;
            border-radius: 2px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        #county-info {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
            min-width: 250px; 
            opacity: 0; 
            transition: opacity 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Washington State COVID-19 Cases per 10k Residents</h1>
        <p class="text-gray-600 mb-6">Interactive choropleth map visualizing COVID-19 cumulative case rates by county.</p>

        <!-- Map Container -->
        <div id='map'></div>

        <!-- Floating Info Box (Hover Data) -->
        <div id="county-info">
            <h3 class="font-bold text-lg text-emerald-700 mb-1" id="county-name">Hover over a county</h3>
            <p class="text-sm text-gray-600">Cases/10k: <span id="cases-value" class="font-semibold text-gray-800">—</span></p>
            <p class="text-sm text-gray-600">Deaths/10k: <span id="deaths-value" class="font-semibold text-gray-800">—</span></p>
            <p class="text-sm text-gray-600">Fully Vax/10k: <span id="vax-value" class="font-semibold text-gray-800">—</span></p>
            <p class="text-xs text-gray-500 mt-2">
                *Data sources: NYT, WA DOH, WA OFM.
            </p>
        </div>

        <!-- Legend Overlay -->
        <div id="legend-overlay" class="map-overlay">
            <h3 class="font-bold text-gray-800 mb-2 border-b pb-1">Cases per 10k</h3>
            <div id="legend-content">
                <!-- Legend items will be inserted here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        // Your Mapbox Access Token
        mapboxgl.accessToken = 'pk.eyJ1IjoiamFrb2J6aGFvIiwiYSI6ImNpcms2YWsyMzAwMmtmbG5icTFxZ3ZkdncifQ.P9MBej1xacybKcDN-jehvw';
        
        // **GeoJSON File Inclusion:** wa-covid-data-102521.geojson
        const geoJsonPath = './assets/wa-covid-data-102521.geojson';
        const dataProperty = 'casePer10k'; // Property used for the choropleth color fill

        // COVID Cases per 10k bins and colors (Higher is Redder)
        const caseStops = [
            [0, '#fee0d2'],     
            [700, '#fc9272'],   
            [1000, '#de2d26'],  
            [1500, '#a50f15'],  
            [2000, '#67000d']   
        ];

        // --- Map Initialization ---
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            center: [-120.8, 47.3], // Center of Washington State
            zoom: 6
        });

        let hoveredCountyId = null;

        // Add a general Mapbox error handler to catch initialization issues
        map.on('error', (e) => {
            console.error('A Mapbox GL JS error occurred:', e.error);
            document.getElementById('map').innerHTML = '<div class="flex items-center justify-center h-full text-red-600 font-bold">Map initialization error. Check console for details.</div>';
        });

        // --- Core Map Logic ---
        map.on('load', async () => {
             console.log("Map loaded successfully. Attempting to fetch GeoJSON data...");
            try {
                // 1. Fetch GeoJSON Data
                const response = await fetch(geoJsonPath);
                 if (!response.ok) {
                     throw new Error(`Failed to load GeoJSON: ${response.status} (${response.statusText}). Check if the file path '${geoJsonPath}' is correct.`);
                }
                const geojsonData = await response.json();
                console.log("GeoJSON data loaded.");


                // 2. Add Data Source (using 'county-data')
                map.addSource('county-data', {
                    type: 'geojson',
                    data: geojsonData
                });

                // 3. Add Choropleth Layer (filled polygons)
                map.addLayer({
                    'id': 'county-fills',
                    'type': 'fill',
                    'source': 'county-data',
                    'layout': {},
                    'paint': {
                        'fill-color': {
                            property: dataProperty, // 'casePer10k' is used for color
                            stops: caseStops
                        },
                        'fill-opacity': 0.8
                    }
                });

                // 4. Add County Border Outline Layer
                map.addLayer({
                    'id': 'county-borders',
                    'type': 'line',
                    'source': 'county-data',
                    'layout': {},
                    'paint': {
                        'line-color': '#fff',
                        'line-width': 1
                    }
                });

                // 5. Setup Legend
                createLegend(caseStops);

                // 6. Setup Interactivity (Hover)
                setupHoverEffect();

            } catch (error) {
                // This catch handles errors from the fetch or data processing
                console.error("Error loading or processing GeoJSON map data:", error.message || error);
                document.getElementById('map').innerHTML = `<div class="flex items-center justify-center h-full text-red-600 font-bold">Error loading map data: ${error.message || 'Check console for details.'}</div>`;
            }
        });

        // --- Interactivity Functions ---

        function setupHoverEffect() {
            const countyInfo = document.getElementById('county-info');

            // Layer for hover effect (outline)
            map.addLayer({
                'id': 'county-highlight',
                'type': 'line',
                'source': 'county-data',
                'paint': {
                    'line-color': '#000000',
                    'line-width': 3
                },
                'filter': ['==', 'name', ''] 
            });

            // Handle mouse move event
            map.on('mousemove', 'county-fills', (e) => {
                const feature = e.features[0];
                if (feature) {
                    const countyName = feature.properties.name;
                    // Extract all relevant attributes for the info box, ensuring they exist
                    const caseRate = feature.properties.casePer10k !== undefined ? feature.properties.casePer10k.toFixed(0) : 'N/A'; 
                    const deathRate = feature.properties.deathPer10k !== undefined ? feature.properties.deathPer10k.toFixed(1) : 'N/A';
                    const vaxRate = feature.properties.fullyVaxPer10k !== undefined ? feature.properties.fullyVaxPer10k.toFixed(0) : 'N/A';

                    if (hoveredCountyId !== countyName) {
                        map.setFilter('county-highlight', ['==', 'name', countyName]);
                        hoveredCountyId = countyName;
                    }

                    // Update Info Box with all three metrics
                    countyInfo.style.opacity = 1;
                    document.getElementById('county-name').textContent = countyName + " County";
                    document.getElementById('cases-value').textContent = caseRate;
                    document.getElementById('deaths-value').textContent = deathRate;
                    document.getElementById('vax-value').textContent = vaxRate;
                }
            });

            // Handle mouse leave event
            map.on('mouseleave', 'county-fills
