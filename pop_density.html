<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U.S. Population Density</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map {
            width: 100%;
            height: 80vh; 
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom styles for the interactive elements */
        .map-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
            max-width: 250px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.875rem;
        }
        .color-box {
            width: 20px;
            height: 12px;
            margin-right: 10px;
            border-radius: 2px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        #state-info {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
            min-width: 200px;
            opacity: 0; 
            transition: opacity 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">U.S. State Population Density (People per Sq. Mile)</h1>
        <p class="text-gray-600 mb-6">Interactive choropleth map demonstrating population density across the United States.</p>

        <!-- Map Container -->
        <div id='map'></div>

        <!-- Floating Info Box (Hover Data) -->
        <div id="state-info">
            <h3 class="font-bold text-lg text-indigo-700 mb-1" id="state-name">Hover over a state</h3>
            <p class="text-sm text-gray-600">Density: <span id="density-value" class="font-semibold text-gray-800">â€”</span></p>
        </div>

        <!-- Legend Overlay -->
        <div id="legend-overlay" class="map-overlay">
            <h3 class="font-bold text-gray-800 mb-2 border-b pb-1">Population Density</h3>
            <div id="legend-content">
                <!-- Legend items will be inserted here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        // Your Mapbox Access Token
        mapboxgl.accessToken = 'pk.eyJ1IjoiamFrb2J6aGFvIiwiYSI6ImNpcms2YWsyMzAwMmtmbG5icTFxZ3ZkdncifQ.P9MBej1xacybKcDN-jehvw';
        
        // **GeoJSON File Inclusion:** stateData.geojson
        const geoJsonPath = './assets/stateData.geojson';

        // Population density bins and colors (People per square mile)
        const densityStops = [
            [0, '#edf8e9'],    
            [50, '#bae4b3'],
            [100, '#74c476'],
            [200, '#31a354'],
            [500, '#006d2c'], 
            [1000, '#003d19'] 
        ];

        // --- Map Initialization ---
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10', 
            center: [-100, 40], 
            zoom: 3 
        });

        let hoveredStateId = null;

        // Add a general Mapbox error handler to catch initialization issues
        map.on('error', (e) => {
            console.error('A Mapbox GL JS error occurred:', e.error);
            // Display a message to the user if the map fails to initialize
            document.getElementById('map').innerHTML = '<div class="flex items-center justify-center h-full text-red-600 font-bold">Map initialization error. Check console for details.</div>';
        });

        // --- Core Map Logic ---
        map.on('load', async () => {
            console.log("Map loaded successfully. Attempting to fetch GeoJSON data...");
            try {
                // 1. Fetch GeoJSON Data
                const response = await fetch(geoJsonPath);
                
                // Throw an error if the response is not ok (e.g., 404 Not Found)
                if (!response.ok) {
                     throw new Error(`Failed to load GeoJSON: ${response.status} (${response.statusText}). Check if the file path '${geoJsonPath}' is correct.`);
                }
                
                const geojsonData = await response.json();
                console.log("GeoJSON data loaded.");

                // 2. Add Data Source (using 'state-data')
                map.addSource('state-data', {
                    type: 'geojson',
                    data: geojsonData
                });

                // 3. Add Choropleth Layer (filled polygons)
                map.addLayer({
                    'id': 'state-fills',
                    'type': 'fill',
                    'source': 'state-data',
                    'layout': {},
                    'paint': {
                        'fill-color': {
                            property: 'density', // Use the 'density' property from the GeoJSON
                            stops: densityStops
                        },
                        'fill-opacity': 0.8
                    }
                });

                // 4. Add State Border Outline Layer
                map.addLayer({
                    'id': 'state-borders',
                    'type': 'line',
                    'source': 'state-data',
                    'layout': {},
                    'paint': {
                        'line-color': '#fff',
                        'line-width': 1
                    }
                });

                // 5. Setup Legend
                createLegend(densityStops);

                // 6. Setup Interactivity (Hover)
                setupHoverEffect();

            } catch (error) {
                // This catch handles errors from the fetch or data processing
                console.error("Error loading or processing GeoJSON map data:", error.message || error);
                document.getElementById('map').innerHTML = `<div class="flex items-center justify-center h-full text-red-600 font-bold">Error loading map data: ${error.message || 'Check console for details.'}</div>`;
            }
        });

        // --- Interactivity Functions ---

        function setupHoverEffect() {
            const stateInfo = document.getElementById('state-info');

            // Layer for hover effect (outline)
            map.addLayer({
                'id': 'state-highlight',
                'type': 'line',
                'source': 'state-data',
                'paint': {
                    'line-color': '#000000',
                    'line-width': 3
                },
                'filter': ['==', 'id', ''] 
            });

            // Handle mouse move event
            map.on('mousemove', 'state-fills', (e) => {
                const feature = e.features[0];
                if (feature) {
                    const stateId = feature.id;
                    const stateName = feature.properties.name;
                    // Robust check for density value
                    const density = feature.properties.density !== undefined && !isNaN(feature.properties.density)
                        ? feature.properties.density.toFixed(1)
                        : 'N/A'; 

                    if (hoveredStateId !== stateId) {
                        map.setFilter('state-highlight', ['==', 'id', stateId]);
                        hoveredStateId = stateId;
                    }

                    stateInfo.style.opacity = 1;
                    document.getElementById('state-name').textContent = stateName;
                    document.getElementById('density-value').textContent = density + " people/sq. mi.";
                }
            });

            // Handle mouse leave event
            map.on('mouseleave', 'state-fills', () => {
                if (hoveredStateId) {
                    map.setFilter('state-highlight', ['==', 'id', '']);
                }
                hoveredStateId = null;
                stateInfo.style.opacity = 0;
            });
        }

        // --- Legend Function ---

        function createLegend(stops) {
            const legendContent = document.getElementById('legend-content');

            for (let i = 0; i < stops.length; i++) {
                const color = stops[i][1];
                const value = stops[i][0];

                let label;
                if (i === stops.length - 1) {
                    label = `${value}+`;
                } else if (i > 0) {
                     const nextValue = stops[i + 1][0];
                     label = `${value} - <${nextValue}`;
                } else {
                    label = `0 - <${stops[1][0]}`;
                }

                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `<span class="color-box" style="background-color: ${color};"></span><span>${label}</span>`;
                legendContent.appendChild(item);
            }
        }
    </script>
</body>
</html>
