<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>U.S. State Population Density</title>
    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ensures the map takes up the full viewport */
        #map{position:absolute;top:0;bottom:0;width:100%}
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans:['Inter','sans-serif']
                    }
                }
            }
        };
    </script>
</head>
<body class="font-sans antialiased bg-gray-50">
    <div id="map"></div>

    <!-- Title and Data Panel Overlay (Top Left) -->
    <div class="absolute top-4 left-4 z-10 p-4 bg-white shadow-2xl rounded-xl max-w-xs md:max-w-md backdrop-blur-sm bg-opacity-90">
        <h1 class="text-xl md:text-2xl font-extrabold text-gray-800">U.S. Population Density</h1>
        <p class="text-sm text-gray-500 mb-2">People per square mile by State</p>
        <div id="data-panel" class="mt-3 p-3 border-l-4 border-indigo-500 bg-indigo-50 rounded-lg">
            <p class="text-lg font-bold text-indigo-700" id="state-name">Hover over a state</p>
            <p class="text-sm text-gray-600">Density: <span id="density-value" class="font-semibold">N/A</span></p>
        </div>
    </div>

    <!-- Legend Overlay (Bottom Left) -->
    <div class="absolute bottom-4 left-4 z-10 p-3 bg-white shadow-2xl rounded-xl backdrop-blur-sm bg-opacity-90">
        <h3 class="text-sm font-bold text-gray-700 mb-1 border-b pb-1">Population Density</h3>
        <div id="legend" class="space-y-1 text-xs"></div>
    </div>

    <script type="module">
        // Using the definitive Mapbox Access Token provided by the user.
        mapboxgl.accessToken = 'pk.eyJ1IjoicmJpc3dhMyIsImEiOiJjbWh4dmV5MmIwNWZqMnZweG03ODEwNWZzIn0.Rjy2XmLjimR0Amk8DAg9yA';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [-98,38],
            zoom: 3.5,
            minZoom: 3
        });

        // Correct GeoJSON path for GitHub Pages hosted under a repository name
        const geoJsonPath = 'assets/stateData.geojson';
        const sourceId = 'us-states-data';
        const layerId = 'pop-density-fill';
        const dataProperty = 'density';
        
        const colorStops = [
            // [Value, Color]
            [0,'#f0f9e8'],      // Less than 50
            [50,'#bae4bc'],     // 50 to 99
            [100,'#7bccc4'],    // 100 to 249
            [250,'#43a2ca'],    // 250 to 499
            [500,'#0868ac']     // 500 and above
        ];

        const stateNameEl = document.getElementById('state-name');
        const densityEl = document.getElementById('density-value');
        let hovered = null;

        /** Updates the floating data panel */
        function updatePanel(name,val){
            stateNameEl.textContent = name;
            // Ensure data is displayed as a number
            densityEl.textContent = (typeof val === 'number' && !isNaN(val)) ? val.toFixed(1) : 'N/A';
        }
        
        /** Generates the legend HTML based on colorStops */
        function generateLegend(){
            const legend = document.getElementById('legend');
            let html='';
            for(let i=0;i<colorStops.length;i++){
                const [v,c] = colorStops[i];
                let label;
                
                if(i===0) label = `Less than ${colorStops[i+1][0]}`;
                else if(i===colorStops.length-1) label = `≥ ${v}`;
                else label = `${v} – ${colorStops[i+1][0]-1}`;
                
                html += `<div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-sm" style="background:${c}"></div><span class="text-gray-700">${label}</span></div>`;
            }
            legend.innerHTML = html;
        }

        map.on('load', () => {
            generateLegend();
            
            // 1. Add GeoJSON source
            map.addSource(sourceId,{
                type:'geojson',
                data: geoJsonPath, // Correct path
                //promoteId:'id'     // Use the 'id' field in GeoJSON for feature state tracking
            });
            
            // 2. Add Choropleth Fill Layer
            map.addLayer({
                id:layerId,
                type:'fill',
                source:sourceId,
                paint:{
                    // Use 'to-number' to force numerical comparison for the choropleth coloring
                    'fill-color': [
                        'step',
                        ['to-number', ['get', dataProperty]],
                        colorStops[0][1], // Default color
                        colorStops[1][0], colorStops[1][1],
                        colorStops[2][0], colorStops[2][1],
                        colorStops[3][0], colorStops[3][1],
                        colorStops[4][0], colorStops[4][1]
                    ],
                    'fill-opacity': ['case',['boolean',['feature-state','hover'],false],0.9,0.8]
                }
            });
            
            // 3. Add Border Line Layer
            map.addLayer({
                id:'state-borders',
                type:'line',
                source:sourceId,
                paint:{
                    'line-color':['case',['boolean',['feature-state','hover'],false],'#000','#fff'],
                    'line-width':['case',['boolean',['feature-state','hover'],false],2,0.5]
                }
            });

            // 4. Handle Mouse Interactions (Hover)
            map.on('mousemove',layerId,e=>{
                if(!e.features.length) return;
                const f=e.features[0];
                const stateId = f.properties.name;
                
                if(hovered !== stateId){
                    if(hovered !== null) map.setFeatureState({source:sourceId,id:hovered},{hover:false});
                    hovered = stateId;
                    map.setFeatureState({source: sourceId, id: stateId}, {hover: true});
                    updatePanel(f.properties.name,f.properties[dataProperty]);
                    map.getCanvas().style.cursor = 'pointer';
                }
            });

            map.on('mouseleave', layerId, () => {
                if(hovered !== null){
                    map.setFeatureState({source:sourceId,id:hovered},{hover:false});
                    hovered = null;
                }
                updatePanel('Hover over a state',null);
                map.getCanvas().style.cursor = '';
            });
        });
    </script>
</body>
</html>
